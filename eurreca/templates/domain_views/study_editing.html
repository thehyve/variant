{% extends "base.html" %}z

{% block extraScripts %}
  <script type="text/javascript" 
    src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js">
  </script>
  <script type="text/javascript" 
    src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js">
  </script>
  <script type="text/javascript" src="{{ STATIC_URL }}js/study_editing.js"></script>
  <script type="text/javascript">
    {# Initialize interaction table relations management #}
    {% for form in formsetInteraction %}
        interactCache[{{forloop.counter|add:"-1"}}] = {};
        {% for gf in formsetGenotype %}
            {# 'value.0' because it doesn't work with lists yet #}
            {% if gf.id.value == form.genotypes.value.0 %}
                interactCache[{{forloop.parentloop.counter|add:"-1"}}]["genotypeNrs"] = {{forloop.counter|add:"-1"}};
            {% endif %} 
        {% endfor %}
        {% for pf in formsetPhenotype %}
            {% if pf.id.value == form.phenotypes.value.0 %}
                interactCache[{{forloop.parentloop.counter|add:"-1"}}]["phenotypeNrs"] = {{forloop.counter|add:"-1"}};
            {% endif %} 
        {% endfor %}
        {% for p in formsetPanel %}
            {% if p.id.value == form.panels.value.0 %}
                interactCache[{{forloop.parentloop.counter|add:"-1"}}]["panelNrs"] = {{forloop.counter|add:"-1"}};
            {% endif %} 
        {% endfor %}
    {% endfor %}    
    
    $(function() {
        {# Add autocompletion to the field with id 'id_study-0-year_of_publication' #}
        {# That is, the study's 'Year of publication' field #}
        var availableFields = [];
        {% for year in year_list %}
            availableFields.push("{{year}}");
        {% endfor %}
        $( "#id_study-0-year_of_publication" ).autocomplete({
            source: availableFields
        });
    });
    
    function switchToTab(tabNum){
        // Counting starts at zero.
        var $tabs = $('#pagetabs').tabs();
        $tabs.tabs('select', tabNum);        
    };
  </script>

{% endblock %}

{% block body %}
    <div id="studylist">
        {% for form in formset %}
            {% if form.id.value == null or form.id.value == '' or form.id.value == None %}
                <form name="study_editing" method="post" action="/studies/create/">
            {% else %}
                <form name="study_editing" method="post" action="/studies/update/{{ form.id.value }}">
            {% endif %}
          
           
            {% csrf_token %}
            {{ formset.management_form }}
            {{ formsetGenotype.management_form }}
            {% for hid in form.hidden_fields %} {{hid}} {% endfor %}
            
            <div id="contextmenu">
                <div class="header roundedcorners">Control panel</div>
                <ul>
                    <li><a href="#" onClick="submitData(); return false;">Submit Data</a></li>
                    <li><a href="#tabs-2" onClick="switchToTab(1); addRow('interaction'); return false;">Add an interaction</a></li>
                    <li><a href="#tabs-2" onClick="switchToTab(1); addRow('genotype'); return false;">Add a genotype</a></li>
                    <li><a href="#tabs-2" onClick="switchToTab(1); addRow('phenotype'); return false;">Add a phenotype</a></li>
                    <li><a href="#tabs-2" onClick="switchToTab(1); addRow('panel'); return false;">Add a panel</a></li>
                    {% if not form.id.value == null and not form.id.value == '' and not form.id.value == None %}
                    <li><a class="interactionTable" href="/studies/remove/{{ form.id.value }}">
                            <img alt="Remove" src="{{ STATIC_URL }}images/icons/delete.png">
                            Remove this study.
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>          
            
            <div id="pagetabs" class="withcontextmenu">
                <ul>
                    <li><a href="#tabs-1">Study information</a></li>
                    <li><a href="#tabs-2">Study related items</a></li>
                </ul>
                <div id="tabs-1">
                    <table>
                        {% for field in form %}
                            {% if not field.name == 'id' %}
                                {% if field.errors %}
                                    <tr class = "error {{ field.name }}">
                                    <td class= "error"></td>
                                {% else %}
                                    <tr class = "formfield {{ field.name }}">
                                    <td class= "formspacer"></td>
                                {% endif %}
                                    {% if field.field.required %}
                                        <td><span class="required">
                                    {% else %}
                                        <td>
                                    {% endif %}
                                        {{ field.label_tag }}</td> 
                                    <td>
                                        {% if field.name == 'year_of_publication' %}
                                            <div class="ui-widget">
                                                {{ field }}
                                            </div>
                                        {% else %}
                                            {{ field }}
                                        {% endif %}
                                    {% if field.field.required %}
                                        </span></td>
                                    {% else %}
                                        </td>
                                    {% endif %}
                                    <td>
                                        {% if field.errors %}
                                            {% for error in field.errors %}
                                                {{ error|escape }} 
                                            {% endfor %}
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}        
                        {% endfor %}
                    </table>
                </div>
                <div id="tabs-2">
                    <table id="interactionTable" class="interactions">
                        <thead>
                            <caption>Interaction</caption>
                            <tr class="header" id="interaction_row">
                                <th id="genotype-gene">Gene</th>
                                <th id="genotype-snp_ref">SNP ref</th>
                                <th id="genotype-snp_variant">SNP variant</th>
                                <th id="phenotype-phenotype_name">Phenotype name</th>
                                <th id="phenotype-environmental_factor">Environmental factor</th>
                                <th id="phenotype-type">Phenotype type</th>
                                <th id="panel-panel_description">Panel description</th>
                                <th id="statistical_model"><span class='required'>Statistical model</span></th>
                                <th id="p_value">p value</th>
                                <th id="ratio_type">ratio_type</th>
                                <th id="ratio">Ratio</th>
                                <th id="ci_lower">95% CI lower</th>
                                <th id="ci_upper">95% CI upper</th>
                                <th id="significant_associations">significant associations</th>
                            </tr>
                        </thead>
                        <tbody id="interaction">
                            {% for form in formsetInteraction %}
                                <tr>
                                    {% if not form.genotypes.value.0 == None %}
                                        {% for gf in formsetGenotype %}
                                            {% if gf.id.value == form.genotypes.value.0 %}
                                                <td class="editable">{{gf.gene.value}}</td>
                                                <td class="editable">{{gf.snp_ref.value}}</td>
                                                <td class="editable">{{gf.snp_variant.value}}</td>
                                            {% endif %} 
                                        {% endfor %}
                                    {% else %}
                                        {% if interactionValues %}
                                            {% for item, value in interactionValues.items %}
                                                {% ifequal forloop.parentloop.counter forloop.counter %}
                                                    <td class="editable">{{value.gene}}</td>
                                                    <td class="editable">{{value.snp_ref}}</td>
                                                    <td class="editable">{{value.snp_variant}}</td>
                                                {% endifequal %}
                                            {% endfor %}
                                        {% else %}
                                            <td class="editable"></td>
                                            <td class="editable"></td>
                                            <td class="editable"></td>
                                        {% endif %}
                                    {% endif %}
                                    {% if not form.phenotypes.value.0 == None %}
                                        {% for pf in formsetPhenotype %}
                                            {% if pf.id.value == form.phenotypes.value.0 %}
                                                <td class="editable">{{pf.phenotype_name.value}}</td>
                                                <td class="editable">{{pf.environmental_factor.value}}</td>
                                                <td class="editable">{{pf.type.value}}</td>
                                            {% endif %} 
                                        {% endfor %}   
                                    {% else %}
                                        {% if interactionValues %}
                                            {% for item, value in interactionValues.items %}
                                                {% ifequal forloop.parentloop.counter forloop.counter %}
                                                    <td class="editable">{{value.phenotype_name}}</td>
                                                    <td class="editable">{{value.environmental_factor}}</td>
                                                    <td class="editable">{{value.type}}</td>
                                                {% endifequal %}
                                            {% endfor %}
                                        {% else %}
                                            <td class="editable"></td>
                                            <td class="editable"></td>
                                            <td class="editable"></td>
                                        {% endif %}
                                    {% endif %}     
                                    {% if not form.panels.value.0 == None %}                        
                                        {% for p in formsetPanel %}
                                            {% if p.id.value == form.panels.value.0 %}
                                                <td class="editable">{{p.panel_description.value}}</td>
                                            {% endif %} 
                                        {% endfor %}
                                    {% else %}
                                        {% if interactionValues %}
                                            {% for item, value in interactionValues.items %}
                                                {% ifequal forloop.parentloop.counter forloop.counter %}
                                                    <td class="editable">{{value.panel_description}}</td>
                                                {% endifequal %}
                                            {% endfor %}
                                        {% else %}
                                            <td class="editable"></td>
                                        {% endif %}
                                    {% endif %}
                                <td class="editable">{% if form.statistical_model.value %}{{ form.statistical_model.value }}{% endif %}</td>
                                <td class="editable">{% if form.p_value.value %}{{ form.p_value.value }}{% endif %}</td>
                                <td class="editable">{% if form.ratio_type.value %}{{ form.ratio_type.value }}{% endif %}</td>
                                <td class="editable">{% if form.ratio.value %}{{ form.ratio.value }}{% endif %}</td>
                                <td class="editable">{% if form.ci_lower.value %}{{ form.ci_lower.value }}{% endif %}</td>
                                <td class="editable">{% if form.ci_upper.value %}{{ form.ci_upper.value }}{% endif %}</td>
                                <td class="editable">{% if form.significant_associations.value %}{{ form.significant_associations.value }}{% endif %}</td>
                                <td class="buttons">
                                    <a onclick="editRow('interaction',this); return false;" href="#">edit</a>&nbsp;<a href="#" onClick="removeRow('interaction',this); return false;">remove</a>
                                </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <a href="#" onClick="addRow('interaction'); return false;">+</a>

                    <table id="genotypeTable" class="interactions">
                        <thead>
                            <caption>Genotype</caption>
                            <tr class="header" id="genotype_row">
                                <th id="gene">Gene</th>
                                <th id="snp_ref">SNP ref</th>
                                <th id="snp_variant">SNP variant</th>
                                <th id="snp_name">SNP name</th>
                                <th id="allele">Allele</th>
                                <th id="mutation">Mutation</th>
                                <th id="zygosity">Zygosity</th>
                            </tr>
                        </thead>
                        <tbody id="genotype">
                            {% for form in formsetGenotype %}
                                <tr>
                                    <td class="editable">{% if form.gene.value %}{{ form.gene.value }}{% endif %}</td>
                                    <td class="editable">{% if form.snp_ref.value %}{{ form.snp_ref.value }}{% endif %}</td>
                                    <td class="editable">{% if form.snp_variant.value %}{{ form.snp_variant.value }}{% endif %}</td>
                                    <td class="editable">{% if form.snp_name.value %}{{ form.snp_name.value }}{% endif %}</td>
                                    <td class="editable">{% if form.allele.value %}{{ form.allele.value }}{% endif %}</td>
                                    <td class="editable">{% if form.mutation.value %}{{ form.mutation.value }}{% endif %}</td>
                                    <td class="editable">{% if form.zygosity.value %}{{ form.zygosity.value }}{% endif %}</td>
                                    <td class="buttons">
                                        <a onclick="editRow('genotype',this); return false;" href="#">edit</a>&nbsp;<a href="#" onClick="removeRow('genotype',this); return false;">remove</a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <a href="#" onClick="addRow('genotype'); return false;">+</a>

                    <table id="phenotypeTable" class="interactions">
                        <thead>
                            <caption>Phenotype</caption>
                            <tr class="header" id="phenotype_row">
                                <th id="phenotype_name">Name</th>
                                <th id="environmental_factor">Environmental Factor</th>
                                <th id="type">Type</th>
                                <th id="intake_data">Intake data</th>
                            </tr>
                        </thead>
                        <tbody id="phenotype">
                            {% for form in formsetPhenotype %}
                                <tr>
                                    <td class="editable">{% if form.phenotype_name.value %}{{ form.phenotype_name.value }}{% endif %}</td>
                                    <td class="editable">{% if form.environmental_factor.value %}{{ form.environmental_factor.value }}{% endif %}</td>
                                    <td class="editable">{% if form.type.value %}{{ form.type.value }}{% endif %}</td>
                                    <td class="editable">{% if form.intake_data.value %}{{ form.intake_data.value }}{% endif %}</td>
                                    <td class="buttons">
                                        <a onclick="editRow('phenotype',this); return false;" href="#">edit</a>&nbsp;<a href="#" onClick="removeRow('phenotype',this); return false;">remove</a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <a href="#" onClick="addRow('phenotype'); return false;">+</a>

                    <table id="panelTable" class="interactions">
                        <thead>
                            <caption>Panel</caption>
                            <tr class="header" id="panel_row">
                                <th id="panel_description">Panel description</th>
                                <th id="number_of_participants"># of participants</th>
                                <th id="gender">Gender</th>
                                <th id="mean_age">Mean age</th>
                                <th id="additional_age_description">Additional age description</th>
                            </tr>
                        </thead>
                        <tbody id="panel">
                            {% for form in formsetPanel %}
                                <tr>
                                    <td class="editable">{% if form.panel_description.value %}{{ form.panel_description.value }}{% endif %}</td>
                                    <td class="editable">{% if form.number_of_participants.value %}{{ form.number_of_participants.value }}{% endif %}</td>
                                    <td class="editable">{% if form.gender.value %}{{ form.gender.value }}{% endif %}</td>
                                    <td class="editable">{% if form.mean_age.value %}{{ form.mean_age.value }}{% endif %}</td>
                                    <td class="editable">{% if form.additional_age_description.value %}{{ form.additional_age_description.value }}{% endif %}</td>
                                    <td class="buttons">
                                        <a onclick="editRow('panel',this); return false;" href="#">edit</a>&nbsp;<a href="#" onClick="removeRow('panel',this); return false;">remove</a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <a href="#" onClick="addRow('panel'); return false;">+</a>
                </div>
            </div>
          {% endfor %}
        </form>
    </div>
{% endblock body %}