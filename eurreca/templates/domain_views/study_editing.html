{% extends "domain_views/study_specific.html" %}

{% block extraScripts %}
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
  <script type="text/javascript">
    genotypeCount = {% if genotypeCount %} {{ genotypeCount }} {% else %} 0 {% endif %}
    phenotypeCount = {% if phenotypeCount %} {{ phenotypeCount }} {% else %} 0 {% endif %}
    panelCount = {% if panelCount %} {{ panelCount }} {% else %} 0 {% endif %}
    interactionCount = {% if interactionCount %} {{ interactionCount }} {% else %} 0 {% endif %}
    
    function incCount(id) {
        if(id=='genotype'){
            genotypeCount = genotypeCount + 1;
        }
        if(id=='phenotype'){
            phenotypeCount = phenotypeCount + 1;
        }
        if(id=='panel'){
            panelCount = panelCount + 1;        
        }
        if(id=='interaction'){
            interactionCount = interactionCount + 1;        
        }
    }
    
    function getCount(id) {
        if(id=='genotype'){
            return genotypeCount;
        }
        if(id=='phenotype'){
            return phenotypeCount;
        }
        if(id=='panel'){
            return panelCount;        
        }
        if(id=='interaction'){
            return interactionCount;        
        }
    }
    
    function addRow(id) {
      strNewRow = '<tr>';
      $('#'+id+'_row').find('th').find('div#variable_name').each(function(){
        strNewRow += "<td id='interactionTable'><input type='text' id='"+id+"-"+getCount(id)+"-"+$(this).html()+"' name='"+id+"-"+getCount(id)+"-"+$(this).html()+"' /></td>"
      });
      strNewRow += '<td id="interactionTable"><a href="#" onClick="saveRow(\''+id+'\',this); return false;">save</a></td>';
      strNewRow += '</tr>';
      $("#"+id).append(strNewRow);
    }
    
    function saveRow(id, that) {
      if(id=='interaction') {
        saveInteractionRow();
      }
      strNewRow = '';
      $(that).parents('tr').find('input').each(function(){
        strNewRow += "<td id='interactionTable'>"+$(this).val()+"&nbsp;";
        strNewRow += "<input type='text' id='"+$(this).attr('id')+"' name='"+$(this).attr('name')+"' style='display: none;' value='"+$(this).val()+"' />"
        strNewRow += '</td>';
      });
      strNewRow += '<td id="interactionTable"><a href="#" onClick="editRow(\''+id+'\',this); return false;">edit</a></td>';
      $(that).parents('tr').html(strNewRow);
      incCount(id);
    }
    
    function saveInteractionRow() {
      $("#genotype").append(
        "<tr><td id='interactionTable'>"+$('#interaction-'+getCount('interaction')+'-gene').val()+
        "<input type='text' name='genotype-"+getCount('genotype')+"-gene' style='display: none;' value='"+$('#interaction-'+getCount('interaction')+'-gene').val()+"' />"+
        "&nbsp;</td><td id='interactionTable'>"+$('#interaction-'+getCount('interaction')+'-snp_ref').val()+
        "<input type='text' name='genotype-"+getCount('genotype')+"-snp_ref' style='display: none;' value='"+$('#interaction-'+getCount('interaction')+'-snp_ref').val()+"' />"+
        +"&nbsp;</td><td id='interactionTable'>&nbsp;</td>"+
        "<td id='interactionTable'>&nbsp;</td><td id='interactionTable'>"+ 
        "<a href='#' onClick='editRow(\"genotype\",this); return false;'>edit</a></td></tr>");
      incCount('genotype');
      $("#phenotype").append("<tr><td id='interactionTable'>"+$('#interaction-'+getCount('interaction')+'-phenotype_name').val()+
        "<input type='text' name='phenotype-"+getCount('phenotype')+"-phenotype_name' style='display: none;' value='"+$('#interaction-'+getCount('interaction')+'-phenotype_name').val()+"' />"+
        "&nbsp;</td><td id='interactionTable'>&nbsp;</td><td id='interactionTable'>"+
        "<a href='#' onClick='editRow(\"phenotype\",this); return false;'>edit</a></td></tr>");
      incCount('phenotype');
      $("#panel").append("<tr><td id='interactionTable'>"+$('#interaction-'+getCount('interaction')+'-description').val()+
        "<input type='text' name='panel-"+getCount('panel')+"-description' style='display: none;' value='"+$('#interaction-'+getCount('interaction')+'-description').val()+"' />"+
        "&nbsp;</td><td id='interactionTable'>&nbsp;</td><td id='interactionTable'>&nbsp;</td>"+ 
        "<td><a href='#' onClick='editRow(\"panel\",this); return false;'>edit</a></td></tr>");
      incCount('panel');
    }
    
    function editRow(id, that) {
      lstHeaders = $('#'+id+'_row').find('th');
      iCounter = 0;
      $(that).parents('tr').find('td').each(function(){
        if(iCounter < lstHeaders.length) {
          oldVal = $(this).html();
          $(this).html("<input type='text' id='"+$(lstHeaders[iCounter]).html()+"'  name='"+$(lstHeaders[iCounter]).html()+"' value='"+oldVal+"' />");
        } else {
          $(this).html('<a href="#" onClick="saveRow(\''+id+'\',this); return false;">save</a>');
        }
        iCounter = iCounter + 1;
      });
    }
  </script>
  <STYLE type="text/css">
    table #interactionTable {
      border: #006dba solid 1px;

    }
    caption #interactionTable {
      font-size: 16pt;
    }
    td #interactionTable {
      border-width: 1px;
      border-style: dotted;
      padding: 10px;
    }
    th #interactionTable {
      border-bottom: black dashed 1px;
      border-left: black dashed 1px;
      padding: 10px;
    }
    a #interactionTable {
      background-color: yellow;
      text-decoration: none;
    }
  </STYLE>
{% endblock %}

{% block studyBlock %}
  {% for form in formset %}
    {% if form.id.value == null or form.id.value == '' or form.id.value == None %}
      <form method="post" action="/studies/create/">
    {% else %}
      <form method="post" action="/studies/update/{{ form.id.value }}">
    {% endif %}
  
      {% csrf_token %}
      {{ formset.management_form }}
      {{ formsetGenotype.management_form }}
      
      {% for hid in form.hidden_fields %} {{hid}}{% endfor %}
      
      <p>Study</p>
      
      <table>
        {% for field in form %}
          {% if not field.name == 'id' %}
          
            {% if field.errors %}
              <tr class = "error {{ field.name }}">
              <td class= "error"></td>
            {% else %}
              <tr class = "formfield {{ field.name }}">
              <td class= "formspacer"></td>
            {% endif %}
            
            <td>{{ field.label_tag }}</td> 
            <td>{{ field }}</td>
            <td>
              {% if field.errors %}
                {% for error in field.errors %}
                  {{ error|escape }} 
                {% endfor %}
              {% endif %}
            </td>
            </tr>
          {% endif %}        
        {% endfor %}
      </table>
    
      <table id="interactionTable">
        <thead>
          <caption id="interactionTable">Interaction</caption>
            <tr id="interaction_row">
           <th id="interactionTable">Genotype_name <div style="display: none;" id="variable_name">gene</div></th>
           <th id="interactionTable">SNP_ref <div style="display: none;" id="variable_name">snp_ref</div></th>
           <th id="interactionTable">Phenotype_name <div style="display: none;" id="variable_name">phenotype_name</div></th>
           <th id="interactionTable">Description <div style="display: none;" id="variable_name">description</div></th>
           <th id="interactionTable">Value <div style="display: none;" id="variable_name">value</div></th>
          </tr>
        </thead>
        <tbody id="interaction">
        
        </tbody>
      </table>
      <a href="#" onClick="addRow('interaction'); return false;">+</a>
      
      <hr />
      <table id="interactionTable">
        <thead>
          <caption id="interactionTable">Genotype</caption>
          <tr id="genotype_row">
           <th id="interactionTable">Name* <div style="display: none;" id="variable_name">gene</div></th>
           <th id="interactionTable">SNP_ref* <div style="display: none;" id="variable_name">snp_ref</div></th>
           <th id="interactionTable">SNP_variant <div style="display: none;" id="variable_name">snp_variant</div></th>
           <th id="interactionTable">Mutation <div style="display: none;" id="variable_name">mutation</div></th>
          </tr>
        </thead>
        <tbody id="genotype">
        
        </tbody>
      </table>
      <a href="#" onClick="addRow('genotype'); return false;">+</a>
      
      <table id="interactionTable">
        <thead>
          <caption id="interactionTable">Phenotype</caption>
          <tr id="phenotype_row">
           <th id="interactionTable">Name* <div style="display: none;" id="variable_name">phenotype_name</div></th>
           <th id="interactionTable">Environmental_Factor <div style="display: none;" id="variable_name">environmental_factor</div></th>
          </tr>
        </thead>
        <tbody id="phenotype">
        
        </tbody>
      </table>
      <a href="#" onClick="addRow('phenotype'); return false;">+</a>
      
      <table id="interactionTable">
        <thead>
          <caption id="interactionTable">Panel</caption>
          <tr id="panel_row">
            <th id="interactionTable">Name*</th>
            <th id="interactionTable">No_of_participants</th>
            <th id="interactionTable">Gender</th>
          </tr>
        </thead>
        <tbody id="panel">
        
        </tbody>
      </table>
      <a href="#" onClick="addRow('panel'); return false;">+</a>
      <hr/>
      <input type="submit" value="Submit"  />
      {% if form.id.value != None %}
          <span class="button">
            <a href="/studies/remove/{{ form.id.value }}">
              <img alt="Remove" src="{{ STATIC_URL }}images/icons/delete.png">
              Remove this study.
            </a>
          </span>
        {% endif %} 
        <p> {{ form.error_dict }} </p>
      {% endfor %}
  </form>
{% endblock studyBlock %} 